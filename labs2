#include <cstdio>
#include <cerrno>
#include <Windows.h>
#include <iostream>
using namespace std;
struct strarray
{
    double* arr;
    int size;
    double min;
    double max;
    double average;
};
extern int errno;
void replaceMinMax(strarray* tmparr)
{
    for (int i = 0; i < tmparr->size; i++)
    {
        if (tmparr->arr[i] == tmparr->max ||
            tmparr->arr[i] == tmparr->min)
        {
            tmparr->arr[i] = tmparr->average;
        }
    }
    return;
}
void print(strarray* tmparr)
{
    for (int i = 0; i < tmparr->size - 1; i++)
    {
        printf("%lf\t", tmparr->arr[i]);
    }
    printf("%lf\n", tmparr->arr[tmparr->size - 1]);
}
DWORD WINAPI min_max(LPVOID param)
{
    strarray* tmparr = (strarray*)param;
    double min = tmparr->arr[0];
    double max = min;
    for (int i = 1; i < tmparr->size; i++)
    {
        if (min > tmparr->arr[i])
        {
            min = tmparr->arr[i];
            Sleep(7);
        }
        if (max < tmparr->arr[i])
        {
            max = tmparr->arr[i];
            Sleep(7);
        }
    }
    tmparr->max = max;
    tmparr->min = min;
    printf("The maximum value in the array:\t%lf\n", max);
    printf("The minimum value in the array:\t%lf\n", min);
    return 0;
}
DWORD WINAPI average(LPVOID param)
{
    strarray* tmparr = (strarray*)param;
    double sum = tmparr->arr[0];
    for (int i = 1; i < tmparr->size; i++)
    {
        sum += tmparr->arr[i];
        Sleep(12);
    }
    tmparr->average = sum / tmparr->size;
    printf("The average value in the array:\t%lf\n", tmparr->average);
    return 0;
}
int main(void)
{
    int size;
    printf("Enter the dimentions of an array: ");
    scanf_s("%d", &size);
    if (size <= 0)
    {
        errno = EDOM;
        perror("Error:\t");
        return EDOM;
    }
    double* arr = (double*)malloc(sizeof(double) * size);
    if (arr == NULL)
    {
        errno = ENOMEM;
        perror("Error:\t");
        return ENOMEM;
    }
    for (int i = 0; i < size; i++)
    {
        scanf_s("%lf", &arr[i]);
    }
    strarray* mainarray = (strarray*)malloc(sizeof(strarray));
    mainarray->arr = arr;
    mainarray->size = size;
    HANDLE hThread_min_max;
    DWORD IDThread_min_max;
    hThread_min_max = CreateThread(NULL, 0, min_max, (void*)mainarray, 0, &IDThread_min_max);
    HANDLE hThread_average;
    DWORD IDThread_average;
    hThread_average = CreateThread(NULL, 0, average, (void*)mainarray, 0, &IDThread_average);
    if (hThread_min_max == NULL || hThread_average == NULL) {
        return GetLastError();
    }
    WaitForSingleObject(hThread_min_max, INFINITE);
    WaitForSingleObject(hThread_average, INFINITE);
    CloseHandle(hThread_min_max);
    CloseHandle(hThread_average);
    replaceMinMax(mainarray);
    print(mainarray);
    free(arr);
    free(mainarray);
    return 0;
}
